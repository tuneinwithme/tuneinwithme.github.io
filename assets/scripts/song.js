// Generated by CoffeeScript 1.7.1
(function() {
  var app,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  app = window.Tuneinwithme;

  app.Song = (function(_super) {
    __extends(Song, _super);

    function Song() {
      return Song.__super__.constructor.apply(this, arguments);
    }

    Song.prototype.init = function(id) {
      this.id = id;
      this.fetchedInfo = false;
      this.on('focus', (function(_this) {
        return function() {
          var _ref;
          if (_this === _this["class"].current) {
            return;
          }
          _this["class"].previous = _this["class"].current;
          _this["class"].current = _this;
          if ((_ref = _this["class"].previous) != null) {
            _ref.trigger('blur');
          }
          app.Room.current.trigger('change-song');
          app.view.trigger('change-song');
          return console.log("song: new! " + _this.id);
        };
      })(this));
      return this.on('blur', (function(_this) {
        return function() {
          return _this.abortFetch;
        };
      })(this));
    };

    Song.prototype.abortFetch = function(callback) {
      var _ref;
      return (_ref = this.fetching) != null ? _ref.abort() : void 0;
    };

    Song.prototype.fetchInfo = function(callback) {
      var url;
      if (this.fetchedInfo) {
        return callback();
      } else {
        this.abortFetch;
        url = 'https://api.spotify.com/v1/tracks?' + $.param({
          ids: this.id.replace('spotify:track:', '')
        });
        return this.fetching = $.getJSON(url, (function(_this) {
          return function(data) {
            var track;
            track = data['tracks'][0];
            _this.image = track['album']['images'][0]['url'];
            _this.thumbnail = track['album']['images'][2]['url'];
            _this.albumName = track['album']['name'];
            _this.artistName = track['artists'][0]['name'];
            _this.name = track['name'];
            _this.fetchedInfo = true;
            return callback();
          };
        })(this));
      }
    };

    Song.all = {};

    Song.get = function(id) {
      if (!(id in Song.all)) {
        Song.all[id] = new Song(id);
      }
      return Song.all[id];
    };

    Song.search = function(input, callback) {
      return Song.searchReturningId(input, function(id) {
        return callback(Song.get(id));
      });
    };

    Song.searchReturningId = function(input, callback) {
      var m, url;
      if (input.search(/^spotify:track:/) === 0) {
        callback(input);
        return;
      }
      m = input.match(/open.spotify.com\/track\/(\w+)/);
      if (m) {
        callback('spotify:track:' + m[1]);
        return;
      }
      url = 'http://ws.spotify.com/search/1/track.json?' + $.param({
        q: input
      });
      return $.getJSON(url, function(data) {
        if (data.tracks[0]) {
          return callback(data.tracks[0].href);
        } else {
          return console.error("No sound found for query \"" + input + "\"");
        }
      });
    };

    Song.current = null;

    Song.previous = null;

    return Song;

  })(app.Base);

}).call(this);

<link rel="stylesheet" type="text/css" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css">
<style type="text/css">	
	body{
		/*background-color: gray;*/
		padding: 2em;
		/*background-repeat: none;*/
		/*background-size: 100%;*/
	}
	body.day{
		background: -moz-linear-gradient(top, rgba(30,87,153,0.48) 0%, rgba(30,87,153,0.55) 5%, rgba(24,85,148,0.69) 14%, rgba(9,80,135,0.78) 37%, rgba(9,80,135,0.86) 59%, rgba(9,80,135,0.86) 71%); /* FF3.6+ */
		background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgba(30,87,153,0.48)), color-stop(5%,rgba(30,87,153,0.55)), color-stop(14%,rgba(24,85,148,0.69)), color-stop(37%,rgba(9,80,135,0.78)), color-stop(59%,rgba(9,80,135,0.86)), color-stop(71%,rgba(9,80,135,0.86))); /* Chrome,Safari4+ */
		background: -webkit-linear-gradient(top, rgba(30,87,153,0.48) 0%,rgba(30,87,153,0.55) 5%,rgba(24,85,148,0.69) 14%,rgba(9,80,135,0.78) 37%,rgba(9,80,135,0.86) 59%,rgba(9,80,135,0.86) 71%); /* Chrome10+,Safari5.1+ */
		background: -o-linear-gradient(top, rgba(30,87,153,0.48) 0%,rgba(30,87,153,0.55) 5%,rgba(24,85,148,0.69) 14%,rgba(9,80,135,0.78) 37%,rgba(9,80,135,0.86) 59%,rgba(9,80,135,0.86) 71%); /* Opera 11.10+ */
		background: -ms-linear-gradient(top, rgba(30,87,153,0.48) 0%,rgba(30,87,153,0.55) 5%,rgba(24,85,148,0.69) 14%,rgba(9,80,135,0.78) 37%,rgba(9,80,135,0.86) 59%,rgba(9,80,135,0.86) 71%); /* IE10+ */
		background: linear-gradient(to bottom, rgba(30,87,153,0.48) 0%,rgba(30,87,153,0.55) 5%,rgba(24,85,148,0.69) 14%,rgba(9,80,135,0.78) 37%,rgba(9,80,135,0.86) 59%,rgba(9,80,135,0.86) 71%); /* W3C */
		filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#7a1e5799', endColorstr='#db095087',GradientType=0 ); /* IE6-9 */
			}
	body.night{
		background: -moz-linear-gradient(top, rgba(68,71,76,0.95) 5%, rgba(68,71,76,0.98) 13%, rgba(74,75,76,1) 20%, rgba(76,76,76,1) 22%, rgba(76,76,76,1) 31%, rgba(56,56,56,1) 49%, rgba(45,45,45,1) 59%, rgba(0,0,0,1) 99%); /* FF3.6+ */
		background: -webkit-gradient(linear, left top, left bottom, color-stop(5%,rgba(68,71,76,0.95)), color-stop(13%,rgba(68,71,76,0.98)), color-stop(20%,rgba(74,75,76,1)), color-stop(22%,rgba(76,76,76,1)), color-stop(31%,rgba(76,76,76,1)), color-stop(49%,rgba(56,56,56,1)), color-stop(59%,rgba(45,45,45,1)), color-stop(99%,rgba(0,0,0,1))); /* Chrome,Safari4+ */
		background: -webkit-linear-gradient(top, rgba(68,71,76,0.95) 5%,rgba(68,71,76,0.98) 13%,rgba(74,75,76,1) 20%,rgba(76,76,76,1) 22%,rgba(76,76,76,1) 31%,rgba(56,56,56,1) 49%,rgba(45,45,45,1) 59%,rgba(0,0,0,1) 99%); /* Chrome10+,Safari5.1+ */
		background: -o-linear-gradient(top, rgba(68,71,76,0.95) 5%,rgba(68,71,76,0.98) 13%,rgba(74,75,76,1) 20%,rgba(76,76,76,1) 22%,rgba(76,76,76,1) 31%,rgba(56,56,56,1) 49%,rgba(45,45,45,1) 59%,rgba(0,0,0,1) 99%); /* Opera 11.10+ */
		background: -ms-linear-gradient(top, rgba(68,71,76,0.95) 5%,rgba(68,71,76,0.98) 13%,rgba(74,75,76,1) 20%,rgba(76,76,76,1) 22%,rgba(76,76,76,1) 31%,rgba(56,56,56,1) 49%,rgba(45,45,45,1) 59%,rgba(0,0,0,1) 99%); /* IE10+ */
		background: linear-gradient(to bottom, rgba(68,71,76,0.95) 5%,rgba(68,71,76,0.98) 13%,rgba(74,75,76,1) 20%,rgba(76,76,76,1) 22%,rgba(76,76,76,1) 31%,rgba(56,56,56,1) 49%,rgba(45,45,45,1) 59%,rgba(0,0,0,1) 99%); /* W3C */
		filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#f244474c', endColorstr='#000000',GradientType=0 ); /* IE6-9 */
	}
	img.album {
		max-width: 400px;
	}
	#albumContainer{
		max-width:400px;
		margin-left: auto;
		margin-right: auto;
		text-align: center;
		color:white;
		font-family: Lucida Sans Unicode;
		font-size:26px;
		padding-bottom: 15px;
		/*background-color: #90FFB7;*/
	}
	.form-control.flasher {
		background-color: white;
		-webkit-transition: background-color 0.9s linear;
				transition: background-color 0.9s linear;
	}
	.form-control.flasher.flash {
		background-color: #FFE68F;
		-webkit-transition: background-color 0s linear;
				transition: background-color 0s linear;
	}	
</style>
<script type="text/javascript" src='https://cdn.firebase.com/js/client/1.0.2/firebase.js'></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<!-- <script type="text/javascript" src='https://cdn.firebase.com/js/simple-login/1.2.1/firebase-simple-login.js'></script> -->
<script type="text/javascript">

LiveDJ = (function(){
	var self = {};

	self.roomName = undefined;
	self.currentSongData = undefined;
	self.lastTrackURL = undefined;

	self.httpGet = function(theUrl){
		var xmlHttp = null;
		xmlHttp = new XMLHttpRequest();
		xmlHttp.open( "GET", theUrl, false );
		xmlHttp.send( null );
		return xmlHttp.responseText;
	}

	self.search = function(query){
		var response = self.httpGet('http://ws.spotify.com/search/1/track.json?q='+query);
		var res = JSON.parse(response);
		if (res.tracks[0]){
			return res.tracks[0].href;
		}
	}
	self.updatePicture = function(){
		var trackID = self.lastTrackURL;
		var response = $.getJSON('https://embed.spotify.com/oembed/?url='+trackID+'&callback=?', function(data) {
			console.log(response);
			// var res = JSON.parse(response);
			bigImage = data.thumbnail_url.replace(/\/cover\//,"/640/");
			$('#albumimage').attr('src', bigImage);
			var albumTitle = document.createElement('text');
			albumTitle.innerHTML = data.title;
			console.log(albumTitle);
			$('#titleContainer').html(albumTitle);
		});
	}

	self.updateInputIfNecessary = function(selector, value) {
		$el = $(selector);
		
		if ($el.val() != value)
			$el.val(value);
		$el.addClass('flash');
		setTimeout(function() {
			$el.removeClass('flash');
		}, 0);
	}

	self.changeRoom = function(roomName) {
		roomName = roomName.toLowerCase();
		self.currentSongData = new Firebase('https://livedj01.firebaseio.com/rooms/'+roomName+'/song');
		// $('#roomName').text(roomName);
		self.currentSongData.on("value", self.onDataChange);

		self.updateInputIfNecessary('#roominput', roomName);
		console.log("room changed to " + roomName);
	}

	self.onDataChange = function(data) {
		if (!data) return;
		self.lastInput = data.val();
		self.lastTrackURL = self.inputToTrackURL(self.lastInput);
		self.currentSongData.set(self.lastTrackURL ? self.lastTrackURL : null);
		self.updateInputIfNecessary('#songinput', self.lastTrackURL);
		self.updatePicture();
		self.changeBackground();
		console.log("Track URL updated: ", self.lastTrackURL);
		// var track = models.Track.fromURI( self.lastTrackURL );
		// models.player.playTrack(track);
	}

	self.inputToTrackURL = function(input) {
		if (input.search(/^spotify:track:/) == 0) return input;
		var m = input.match(/open.spotify.com\/track\/(\w+)/);
		if (m) return 'spotify:track:' + m[1];
		return self.search(input);
	}

	self.submitSong = function() {
		self.currentSongData.set($('#songinput').val());
		$('#songinput').select();
	}

	self.submitRoom = function() {
		self.changeRoom($('#roominput').val());
		$('#roominput').select();
	}

	self.init = function() {
		self.changeRoom('welcometohacktech');
		$('#songinput').select();
	}

	self.changeBackground = function() {
			var hour = new Date().getHours()
			if (hour < 7 || hour > 18) {
				$('body').removeClass('day');
				$('body').addClass('night');
			}else{
				$('body').removeClass('night');
				$('body').addClass('day');
	}
};
	return self;
})();

$(document).ready(LiveDJ.init);
</script>

<div id="albumContainer">
	<img class="album" id="albumimage" alt="sample">
	<div id="titleContainer"></div>
</div>

<form role="form">
  <div class="form-group">
	<label for="input">Room ID</label>
	<input type="text" class="form-control flasher" id="roominput" placeholder="room:&hellip;">
  </div>
  <button type="submit" id="submitRoom" onclick="LiveDJ.submitRoom(); return false;" class="btn btn-default">Change Room</button>
</form>

<form role="form">
  <div class="form-group">
	<label for="input">Song Spotify URL</label>
	<input type="text" class="form-control flasher" id="songinput" placeholder="spotify:track:&hellip;">
  </div>
  <button type="submit" id="submitSong" onclick="LiveDJ.submitSong(); return false;" class="btn btn-default">Submit Song</button>
</form>
